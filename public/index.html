<!DOCTYPE html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="icon" type="image/x-icon" href="favicon.png ">
  <!-- Javascript y css de la libreria -->
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
  <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">

  <!-- Estilos propios -->
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="multiple-select.css" />

  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js?v=5.2.4"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.js?v=5.2.4"></script>
  <link rel="stylesheet" type="text/css" 
      href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.css?v=5.2.4">

  <script src="multiple-select.js"></script>
</head>

<body>
  <div class="gantt_control">
    <div class="filters_wrapper" id="filters_wrapper">
      <!-- Control Box -->
      <div class="container">
        <div class="row space-between" style="margin: 1rem">
          <!-- col: First filter -->
          <div class="col text-center d-flex justify-content-center align-items-center border-end">
            <div class="m-4">
              <label for="filterData" class="mb-2">
                Entrer a block code or description
              </label>
              <input type='text' id="filterData" oninput='gantt.$doFilter("filterData", this.value)' placeholder="00A8B"
                style="padding: 0.5rem; margin: 0.5rem">
            </div>
          </div>
          <!-- col: Second filter -->
          <div class="col d-flex flex-column justify-content-center align-items-center gap-4 ml-2">
            <select id="SpecialtiesDropdown" class="form-control">
              <!-- COMBOS - specialties -->
            </select>
            <select name="PhaseDropdown" id="PhaseDropdown" class="form-control">
              <!--COMBOS - Phase-->
            </select>
          </div>
          <!-- col: Filter button -->
          <div class="col d-flex justify-content-around align-items-center gap-4 border-end">
            <input class="action" name="addLabels" value="Apply labels" type="button">
            <input class="action" name="deleteLabels" value="Delete labels" type="button">
            <!-- <button type='button' style="padding: 0.5rem 2rem; border-radius: 5px"> -->
            </button>
          </div>
          <!-- col: Save button -->
          <div class="col d-flex flex-column justify-content-center align-items-center">
            <p>Save your changes</p>
            <button
              style="padding: 0.5rem 2rem; border-radius: 5px"
              onclick="exportGanttData()"
            >
              Save
            </button>
          </div>
          <!-- col: Export data -->
          <div class="col d-flex flex-column justify-content-center align-items-center">
            <p>Export to Excel</p>
            <button 
              type='button' 
              style="padding: 0.5rem 2rem; border-radius: 5px"
              onclick="exportJson()"
            >
              Export
          </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Donde se renderiza el gantt -->
  <div id="gantt_here" style='width:100%; height:100%;'></div>

  <!-- Scripts mios -->
  <script src="services/index.js"></script>
  <script src="scripts/index.js"></script>

  <!-- Scripts adicionales de la libreria -->

  <!-- Script using Gantt API -->
  <script type="text/javascript">
    //https://qdmana.com/2022/141/202205211548409382.html //informacion de configuracion
    // Activacion de plugins
    gantt.plugins({
      multiselect: true,         // Permite seleccionar varias tareas en el diagrama de Gantt a la vez
      tooltip: true,             // Tooltip
      keyboard_navigation: true, // Permite navegar por el diagrama de Gantt con la ayuda del teclado.
      critical_path: true,       // Rutas Critical
      undo: true,                // Sin implementar
      redo: true                 // Sin implementar
    });

    //-- OTRAS CONFIGURACIONES --//
    //Desplácese el contenedor Gantt a la posición especificada
    gantt.scrollTo(2, null)
    //activa el modo 'rama' que permite reordenar verticalmente las tareas dentro del mismo nivel de árbol
    gantt.config.order_branch = true
    //Abre todas las ramas inicialmente
    gantt.config.open_tree_initially = true
    //para extender automáticamente la escala de tiempo para adaptarse a todas las tareas mostradas
    gantt.config.fit_tasks = true
    //Establezca la altura del encabezado del gráfico Gantt
    gantt.config.scale_height = 50

    // Setea la escala de anios
    gantt.config.scales = [
      { unit: "week", format: "%M %Y", css: daysStyle },
      { unit: "day", format: "%d %D", css: daysStyle }
    ];

    // La configuracion de la columna de la izquierda del Gantt
    //https://docs.dhtmlx.com/gantt/samples/05_lightbox/14_jquery_multiselect.html
    gantt.config.columns = [
      { name: "block", tree: false, width: 60, resize: true, label: "Code", align: "center" },
      { name: "text", tree: false, width: 200, resize: true, label: "Block description", align: "left" },
      {
        name: "labels", tree: false, width: 200, resize: true, label: "Classifies", align: "center",
        template: function (task) {
          if (task.specialties == gantt.config.types.project) return "";
          var result = "";
          var tSpecialties = task.labels;

          if (!tSpecialties || !tSpecialties.length) {
            return "Unassigned";
          } else {
            if (typeof tSpecialties === "object") {
              tSpecialties.forEach(function (ownerId) {
                var owner = findSpecialties(ownerId);
                if (!owner) return;

                const label = handleLabel(owner);
                // console.log('final label', label);

                result += `<div class='owner-${label.cssClass}' title='${owner.label}'>${label.shortLabel}</div>`;
              });
            } else {
              console.error('A label/s was not given as an array');
            }
          }
          return result;
        }
      },
    ];

    // https://docs.dhtmlx.com/gantt/desktop__custom_editor.html
    gantt.form_blocks["multiselect"] = {
      render: function (sns) {
        var height = (sns.height || "23") + "px";
        var html = "<div class='gantt_cal_ltext gantt_cal_chosen gantt_cal_multiselect'"+
          "style='height:"+ height + ";'><select data-placeholder='...'"+
          "class='chosen-select' multiple>";
        if (sns.options) {
          for (var i = 0; i < sns.options.length; i++) {
            if(sns.unassigned_value !== undefined && sns.options[i].key==sns.unassigned_value){
              continue;
            }
            html+="<option value='" +sns.options[i].key+ "'>"+sns.options[i].label+"</option>";
          }
        }
        html += "</select></div>";
        return html;
      },
      
      set_value: function (node, value, ev, sns) {
        node.style.overflow = "visible";
        node.parentNode.style.overflow = "visible";
        node.style.display = "inline-block";
        var select = $(node.firstChild);
    
        if (value) {
          value = (value + "").split(",");
          select.val(value);
        }
        else {
          select.val([]);
        }
    
        select.chosen();
        if(sns.onchange){
          select.change(function(){
            sns.onchange.call(this);
          })
        }
        select.trigger('chosen:updated');
        select.trigger("change");
      },
      
      get_value: function (node, ev) {
        return $(node.firstChild).val();
      },
      
      focus: function (node) {
        $(node.firstChild).focus();
      }
    };

    //Text inside block
    gantt.templates.task_text = function (start, end, task) {
      return "<b>" + task.block + "</b>";
    };

    //Vista de los fines de semanas
    var daysStyle = function (date) {
      var dateToStr = gantt.date.date_to_str("%D");
      gantt.templates.timeline_cell_class = function (task, date) {
        if (dateToStr(date) == "Sun" || dateToStr(date) == "Sat") return "weekend";
        return "";
      };
    };

    //Busquedad departida de la lista de servicio
    function findSpecialties(id) {
      var list = gantt.serverList("labels");
      for (var i = 0; i < list.length; i++) {
        if (list[i].key == id) {
          return list[i];
        }
      }
      return null;
    }

    async function initApp() {
      const dataFromApi = await getDataInDb()

      console.log('Data from API', dataFromApi);
      console.log('Data', dataFromApi.data)
      console.log('Links', dataFromApi.links)
      console.log('Number of blocks: ', dataFromApi.data.length)
      // console.log('fecha inicio', dataFromApi.data[0].start_date.toJSON())
      // console.log('fecha fin', dataFromApi.data[0].end_date.toJSON())
      
      // Para cada tarea asigarle el codigo del bloque como id
      dataFromApi.data.forEach((task) => {
        task.id = task.block;
      });

      console.log('Data after change ID', dataFromApi.data)

      gantt.parse(dataFromApi);
      // gantt.load("linked_data.json")

      const res = await getLabelsFromApi('')
      const { DATA } = res
      const labels = DATA.slice(2)

      gantt.serverList("labels", labels);

      console.log('newlabels', gantt.serverList("labels"));

      //--- lightbox ---//
      // Para configurar los elementos emergentes incorporados de Gantt (Contenido del título)
      gantt.templates.lightbox_header = function (start_date, end_date, task) {
        return `<b>Code  ${task.block}</b>`
      };
      
      gantt.config.lightbox.sections = [
        { name: "title", height: 60, map_to: "text", type: "textarea", focus: true },
        { name: "labels", height: 35, map_to: "labels", type: "multiselect", options: gantt.serverList("labels") },
        { name: "time", height: 72, map_to: "auto", type: "time" },
      ];

      //etiquetas de los campos
      gantt.locale.labels.section_block = "Code";
      gantt.locale.labels.section_title = "Description";
      gantt.locale.labels.section_labels = "Labels";
      gantt.locale.labels.section_time = "Time frame";
    }

    initApp()
    gantt.init("gantt_here");

    // gantt.load("data.json")
    //--------------------------------------------------------------------------------


    // Control multipleSelect ------------------------------------------------------------------
    $(async function () {
      $("#SpecialtiesDropdown").html(await getListOfLabels('01'));
      $('#SpecialtiesDropdown').change(function () {
        gantt.$doFilter('#SpecialtiesDropdown', $(this).val())
      }).multipleSelect({
        width: '100%',
        placeholder: "Specialties",
        filter: true,
      });
    });

    $(async function () {
      $("#PhaseDropdown").html(await getListOfLabels('02'));
      $('#PhaseDropdown').change(function () {
        gantt.$doFilter('#PhaseDropdown', $(this).val())
      }).multipleSelect({
        width: '100%',
        placeholder: "Phase",
        filter: true,
      });
    });
    //--------------------------------------------------------------------------------

    // Filter -----------------------------------------------------------------------------
    let filterValue = "";
    let delay;

    gantt.$doFilter = function (element, value) {
      if (element == 'filterData'){
        filterValue = value;
        clearTimeout(delay);
        delay = setTimeout(function () {
          gantt.render();
          document.querySelector("#filterData").focus();
        }, 200)
      }

      if (element == '#PhaseDropdown') {
        filter_fase = value;
        gantt.render();
      }
      if (element == '#SpecialtiesDropdown') {
        filter_partida = value;
        gantt.render();
      }
      if (element == '#ContractsDropdown') {
        filter_contracto = value;
        gantt.render();
      }
    }

    // Events -----------------------------------------------------------------------------
    gantt.attachEvent("onTaskClick", function (id, e) {
      var task = gantt.getTask(id);
      console.log({ task })
      return true;
    });
    gantt.attachEvent("onBeforeTaskDisplay", function (id, task) {
      if (!filterValue) return true;

      var normalizedText = task.text.toLowerCase();
      var normalizedCode = task.block.toLowerCase()

      var normalizedValue = filterValue.toLowerCase();
      return normalizedText.indexOf(normalizedValue) > -1 || normalizedCode.indexOf(normalizedValue) > -1;
    });

    // Otras functiones -------------------------------------------------------------------
    function exportJson() {
      gantt.exportToJSON({
        name:"gantt.json"
      });
    }

    function exportSheet() {
      gantt.exportToExcel({
        name:"gantt.xlsx"
      });
    }

    function exportGanttData() {
      const json = gantt.serialize();
      storeGanttData(json)
    }

    // Recupera todos los valores de los campos seleccionados del elemento <select>
    function getSelectedValues() {
      let selectedSpecialities = $('#SpecialtiesDropdown').multipleSelect('getSelects');
      let selectedPhases = $('#PhaseDropdown').multipleSelect('getSelects');
      let selectedLabels = [...selectedSpecialities, ...selectedPhases]

      return selectedLabels
    }

    // Aplicar etiquetas a multiples tareas simultaneamente
    (function () {
      var actions = {
        addLabels: function() {
          return getSelectedValues()
        },
        deleteLabels: function() {
          return getSelectedValues()
        }
      }

      gantt.performAction = function (actionName) {
        var action = actions[actionName];

        if (!action)
          return;

        // if(singularAction[actionName]){
        //   action();
        //   return;
        // }

        if (actionName === 'addLabels') {
          gantt.batchUpdate(function () {
            gantt.eachSelectedTask(function(task_id){
              var selectedLabels = action();
              console.log('selectedLabels', selectedLabels)
  
              // get task
              var task = gantt.getTask(task_id);
  
              console.log('Labels before changes', task.labels)
  
              if (task.labels) {
                task.labels = [...task.labels, ...selectedLabels]
                task.labels = [...new Set(task.labels)];
              } else {
                task.labels = selectedLabels
              }
            });
          })
        }

        if (actionName === 'deleteLabels') {
          gantt.batchUpdate(function () {
            gantt.eachSelectedTask(function(task_id){
              var selectedLabels = action();
              console.log('selectedLabels', selectedLabels)
  
              // get task
              var task = gantt.getTask(task_id);
  
              console.log('Labels before changes', task.labels)
  
              if (task.labels) {
                task.labels = task.labels.filter(label => !selectedLabels.includes(label))
              }
            });
          })
        }
        
        return
      }
    })()

    var $elms = document.getElementsByClassName("action");
    
    for (var i = 0; i < $elms.length; i++) {
      $elms[i].onclick = function() {
        gantt.performAction(this.name)
      }
    }

    // Funcion para validar la fecha de un bloque con dependencia
    gantt.attachEvent("onBeforeTaskChanged", function(id, mode, task){
      //any custom logic here

      console.log(task)
      console.log(task.$source)
      console.log(task.$target)
      
      return true;
    });
  </script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js"
    integrity="sha384-IDwe1+LCz02ROU9k972gdyvl+AESN10+x7tBKgc9I5HFtuNz0wWnPclzo6p9vxnk"
    crossorigin="anonymous"></script>

  <!-- dhtmlx extensions -->
  <script src="https://export.dhtmlx.com/gantt/api.js"></script>
</body>