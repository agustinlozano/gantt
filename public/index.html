<!DOCTYPE html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="icon" type="image/x-icon" href="favicon.png ">
  <!-- Javascript y css de la libreria -->
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
  <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">

  <!-- Cosas que no se que hacen -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="multiple-select.js"></script>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="multiple-select.css" />
</head>

<body>
  <!-- Filter-->
  <div class="gantt_control">
    <div class="filters_wrapper" id="filters_wrapper">
      <!-- Control Box -->
      <div class="container">
        <div class="row space-between" style="margin: 1rem">
          <!--One of four columns - CAMPOS OF FILTER -->
          <div class="col text-center d-flex justify-content-center align-items-center">
            <!-- A div placed in center with bootstrap -->
            <div class="">
              <label for="filterData">
                Entrer a block code or description
              </label>
              <input type='text' id="filterData" oninput='gantt.$doFilter("filterData", this.value)' placeholder="00A8B"
                style="padding: 0.5rem; margin: 0.5rem">
            </div>
          </div>
          <!--Two Combo-->
          <div class="col d-flex flex-column justify-content-center align-items-center">
            <!-- COMBOS - specialties -->
            <select id="SpecialtiesDropdown" class="form-control">
              <option value="59"> Fundaciones </option>
              <option value="5A"> Estructuras</option>
              <option value="5B"> Albañilería</option>
              <option value="5H"> Terminaciones</option>
              <option value="5G"> Cerramientos</option>
              <option value="5F"> Inst. Mecánicas</option>
              <option value="5E"> Inst. C. Incendios</option>
              <option value="5C"> Inst. Sanitarias</option>
              <option value="5D"> Inst. Eléctricas</option>
            </select>

            <div style="margin-top:5px;"></div>

            <!--COMBOS - Contratista -->
            <select id="ContractsDropdown" class="form-control" style="margin-top:10px; margin-bottom: 10px;">
              <option value="01"> Estructura</option>
              <option value="02"> Albañilería</option>
              <option value="03"> Carpinterias</option>
              <option value="04"> Plomería</option>
              <option value="05"> Electricidad</option>
              <option value="06"> Incendios</option>
              <option value="07"> Termomecanicas</option>
              <option value="08"> Ascensores</option>
              <option value="09"> Pintura</option>
              <option value="0A"> Terminaciones</option>
              <option value="0B"> Herrería</option>
              <option value="0C"> Mobiliario</option>
              <option value="0D"> Construcción en Seco</option>
            </select>

            <div style="margin-top:5px;"></div>

            <!--COMBOS - Phase-->
            <select name="PhaseDropdown" id="PhaseDropdown" class="form-control">
              <option value="1"> Etapa I</option>
              <option value="2"> Etapa II</option>
            </select>
          </div>

          <!--Three  of four columns - button:  FILTER , ATTACH TO BLOCKS \ End Control Box -->
          <div class="col d-flex justify-content-around align-items-center gap-">
            <button type='button' style="padding: 0.5rem 2rem; border-radius: 5px">
              Filter
            </button>
            <button type='button' style="padding: 0.5rem 2rem; border-radius: 5px">
              Apply new tags
            </button>
          </div>
        </div>

      </div>

    </div>
  </div>
  <!-- Donde se renderiza el gantt -->
  <div id="gantt_here" style='width:100%; height:100%;'></div>

  <script type="text/javascript">
    //https://qdmana.com/2022/141/202205211548409382.html //informacion de configuracion
    // Activacion de plugins
    gantt.plugins({
      multiselect: true,         // Permite seleccionar varias tareas en el diagrama de Gantt a la vez
      tooltip: true,             // Tooltip
      keyboard_navigation: true, // Permite navegar por el diagrama de Gantt con la ayuda del teclado.
      critical_path: true,       // Rutas Critical
      undo: true,                // Sin implementar
      redo: true                 // Sin implementar
    });

    //-- OTRAS CONFIGURACIONES --//
    //Desplácese el contenedor Gantt a la posición especificada
    gantt.scrollTo(2, null)
    //activa el modo 'rama' que permite reordenar verticalmente las tareas dentro del mismo nivel de árbol
    gantt.config.order_branch = true
    //Abre todas las ramas inicialmente
    gantt.config.open_tree_initially = true
    //para extender automáticamente la escala de tiempo para adaptarse a todas las tareas mostradas
    gantt.config.fit_tasks = true
    //Establezca la altura del encabezado del gráfico Gantt
    gantt.config.scale_height = 50

    // Setea la escala de anios
    gantt.config.scales = [
      { unit: "week", format: "%M %Y", css: daysStyle },
      { unit: "day", format: "%d %D", css: daysStyle }
    ];

    // La configuracion de la columna de la izquierda del Gantt
    //https://docs.dhtmlx.com/gantt/samples/05_lightbox/14_jquery_multiselect.html
    gantt.config.columns = [
      { name: "block", tree: false, width: 60, resize: true, label: "Code", align: "center" }, //label: textFilter,
      { name: "text", tree: false, width: 200, resize: true, label: "Description Blocks", align: "left" }, //label: textFilter,
      {
        name: "labels", tree: false, width: 165, resize: true, label: "Classifies", align: "center", template: function (task) {
          if (task.labels == gantt.config.types.project) return "";
          var result = "";
          var tSpecialties = task.labels;

          if (!tSpecialties || !tSpecialties.length) {
            return "Unassigned";
          } else {
            if (typeof tSpecialties === "string") {

              var dSpecial = findSpecialties(tSpecialties);
              if (!dSpecial)
                return;
              result += "<div class='owner-label" + dSpecial.label.substr(0, 2) + "' title='" + dSpecial.label + "'>" + dSpecial.label.substr(0, 2) + "</div>";

            } else if (typeof tSpecialties === "object") {

              tSpecialties.forEach(function (ownerId) {
                var owner = findSpecialties(ownerId);
                if (!owner)
                  return;
                result += "<div class='owner-label" + owner.label.substr(0, 2) + "' title='" + owner.label.substr(0, 2) + "'>" + owner.label.substr(0, 2) + "</div>";

              });
            }
          }
          return result;
        }
      },
    ];

    //Text inside block
    gantt.templates.task_text = function (start, end, task) {
      return "<b>" + task.block + "</b>";
    };

    //Vista de los fines de semanas
    var daysStyle = function (date) {
      var dateToStr = gantt.date.date_to_str("%D");
      gantt.templates.timeline_cell_class = function (task, date) {
        if (dateToStr(date) == "Sun" || dateToStr(date) == "Sat") return "weekend";
        return "";
      };
    };

    //--- lightbox ---//
    // Para configurar los elementos emergentes incorporados de Gantt (Contenido del título)
    gantt.templates.lightbox_header = function (start_date, end_date, task) {
      return `<b>Code  ${task.block}</b>`
    };

    gantt.config.lightbox.sections = [
      { name: "title", height: 60, map_to: "text", type: "textarea", focus: true },
      { name: "labels", height: 30, map_to: "labels", type: "multiselect", options: gantt.serverList("specialties"), },
      { name: "time", height: 72, map_to: "auto", type: "time" },
    ];

    //etiquetas de los campos
    gantt.locale.labels.section_block = "Hola";
    gantt.locale.labels.section_title = "Description";
    gantt.locale.labels.section_labels = "Labels";
    gantt.locale.labels.section_time = "Time frame";

    //Busquedad departida de la lista de servicio
    function findSpecialties(id) {
      var list = gantt.serverList("specialties");
      for (var i = 0; i < list.length; i++) {
        if (list[i].key == id) {
          return list[i];
        }
      }
      return null;
    }

    // Events -----------------------------------------------------------------------------
    gantt.attachEvent("onTaskClick", function (id, e) {
      var task = gantt.getTask(id);
      console.log({ task })
      return true;
    });
    //--------------------------------------------------------------------------------

    // MIO --------------------------------------------------------------------------------
    async function getDataInDb() {
      const res = await fetch("http://36.bimtrazer.com/api/GetDataProj/GanttDataLoad")

      return await res.json()
    }

    async function initApp() {
      const dataFromApi = await getDataInDb()

      console.log({ dataFromApi })
      console.log('Number of blocks: ', dataFromApi.data.length)

      gantt.parse(dataFromApi);
    }

    initApp()
    gantt.init("gantt_here");
    // gantt.load("data.json")
    //--------------------------------------------------------------------------------

    // Control multipleSelect ------------------------------------------------------------------
     $(function () {
      //$("#SpecialtiesDropdown").html(listSpecialtiesSelect()); // para traer la data desde el json
      $('#SpecialtiesDropdown').change(function () {
        console.log("Specialties: ", $(this).val());
        gantt.$doFilter('#SpecialtiesDropdown', $(this).val())
      }).multipleSelect({
        width: '100%',
        placeholder: "Specialties",
        filter: true,
      });
    });

    $(function () {
      //$("#ContractsDropdown").html(listContractsSelect()); //para traer la data desde el json
      $('#ContractsDropdown').change(function () {
        console.log("Contracts: ", $(this).val());
        gantt.$doFilter('#ContractsDropdown', $(this).val())
      }).multipleSelect({
        width: '100%',
        placeholder: "Contracts",
        filter: true,
      });
    });

    $(function () {
      $('#PhaseDropdown').change(function () {
        gantt.$doFilter('#PhaseDropdown', $(this).val())
      }).multipleSelect({
        width: '100%',
        placeholder: "Phase",
      });
    });
    //--------------------------------------------------------------------------------

    // Filter -----------------------------------------------------------------------------
    let filterValue = "";
    let delay;

    gantt.$doFilter = function (element, value) {
      if (element == 'filterData'){
        filterValue = value;
        clearTimeout(delay);
        delay = setTimeout(function () {
          gantt.render();
          document.querySelector("#filterData").focus();
        }, 200)
      }

      if (element == '#PhaseDropdown') {
        filter_fase = value;
        gantt.render();
      }
      if (element == '#SpecialtiesDropdown') {
        filter_partida = value;
        gantt.render();
      }
      if (element == '#ContractsDropdown') {
        filter_contracto = value;
        gantt.render();
      }
    }

    gantt.attachEvent("onBeforeTaskDisplay", function (id, task) {
      if (!filterValue) return true;

      var normalizedText = task.text.toLowerCase();
      var normalizedCode = task.block.toLowerCase()

      var normalizedValue = filterValue.toLowerCase();
      return normalizedText.indexOf(normalizedValue) > -1 || normalizedCode.indexOf(normalizedValue) > -1;
    });
    //--------------------------------------------------------------------------------
  </script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js"
    integrity="sha384-IDwe1+LCz02ROU9k972gdyvl+AESN10+x7tBKgc9I5HFtuNz0wWnPclzo6p9vxnk"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
    crossorigin="anonymous"></script>
</body>